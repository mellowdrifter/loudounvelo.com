<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{SITE_TITLE}}</title>
  <style>
    :root {
      --bg: #0b0d10;
      --card: #12161b;
      --muted: #9aa3af;
      --text: #e5e7eb;
      --accent: #60a5fa;
      --road: #10b981;   /* green pill */
      --gravel: #f59e0b; /* amber pill */
      --border: #1f2937;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius: 16px;
      --gap: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans",
               "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: var(--font); }
    a { color: inherit; text-decoration: none; }
    .wrap { max-width: 1100px; margin: 28px auto 80px; padding: 0 16px; }

    header {
      display: grid; gap: 8px;
      grid-template-columns: 1fr auto;
      align-items: center; margin: 8px 0 18px;
    }
    .title h1 { font-size: clamp(28px, 3.3vw, 40px); margin: 0; letter-spacing: .3px; }
    .subtitle { color: var(--muted); font-size: 14px; }
    .meta { font-variant-numeric: tabular-nums; }

    .controls {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: flex-end;
    }
    .toggle, .select, .range {
      background: var(--card); border: 1px solid var(--border); border-radius: 999px;
      padding: 8px 12px; font-size: 14px; color: var(--text);
    }
    .toggle { display: inline-flex; gap: 10px; align-items: center; cursor: pointer; user-select: none; }
    .toggle input { accent-color: var(--accent); }
    .select { border-radius: 12px; }
    .range { display:flex; align-items:center; gap:8px; border-radius: 12px; }
    .range input[type="range"] { width: 160px; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: var(--gap);
      margin-top: 18px;
    }

    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: clip; box-shadow: var(--shadow);
      display: flex; flex-direction: column; min-height: 100%;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(0,0,0,.45); }

    .imgwrap {
      aspect-ratio: 16 / 9; background: #0e1318; position: relative; overflow: hidden;
    }
    .imgwrap img {
      width: 100%; height: 100%; object-fit: cover; display:block;
    }
    .imgwrap .fallback {
      position:absolute; inset:0; display:grid; place-items:center; color:#94a3b8; font-weight:600; font-size: 18px;
      background: linear-gradient(180deg, #0e1318, #0b0d10);
    }

    .body { padding: 14px 14px 6px; display:flex; flex-direction: column; gap: 10px; }
    .title-row { display:flex; align-items: flex-start; gap:8px; }
    .pill {
      font-size: 12px; font-weight: 600; letter-spacing:.2px; padding: 4px 8px; border-radius:999px;
      border: 1px solid var(--border); color:#0b0d10;
    }
    .pill.road { background: var(--road); }
    .pill.gravel { background: var(--gravel); }
    .route-title { margin:0; font-size: 18px; line-height: 1.25; flex:1; }
    .desc { color: var(--muted); font-size: 14px; line-height: 1.45; max-height: 3.6em; overflow: hidden; }

    .stats {
      display:flex; gap: 14px; align-items: center; font-size: 14px; color: #cbd5e1;
      border-top: 1px dashed var(--border); padding-top:10px; margin-top: 4px;
    }
    .stat b { font-variant-numeric: tabular-nums; }
    .actions {
      display:flex; gap: 10px; padding: 12px 14px 14px;
    }
    .btn {
      flex:1; text-align:center; padding: 10px 12px; border-radius: 12px;
      border: 1px solid var(--border); background: #0f172a; color: #e2e8f0; font-weight: 600;
      transition: background .15s ease, border-color .15s ease, transform .05s ease;
    }
    .btn.primary { background: var(--accent); color:#0b0d10; border-color: rgba(255,255,255,.08); }
    .btn:hover { transform: translateY(-1px); }
    .footer-note { color: var(--muted); font-size:12px; margin-top: 18px; text-align:center; }

    @media (max-width: 540px) {
      header { grid-template-columns: 1fr; }
      .controls { justify-content: flex-start; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Loudoun Velo</h1>
        <div class="subtitle meta">
          <span id="routeCount">{{ROUTE_COUNT}}</span> routes • Built: <span id="buildDate">{{BUILD_DATE}}</span>
        </div>
      </div>

      <div class="controls">
        <label class="toggle" title="Toggle miles/feet">
          <input id="unitToggle" type="checkbox" />
          <span><b>Mi/Ft</b></span>
        </label>
        <select id="typeFilter" class="select" title="Filter by type">
          <option value="all">All Types</option>
          <option value="road">Road</option>
          <option value="gravel">Gravel</option>
        </select>
      </div>
    </header>

    <section class="grid" id="grid"></section>

    <div class="footer-note">Built with ❤️ for the Loudoun cycling community</div>
  </div>

  <script>
    // Injected by build.py
    const ROUTES = {{ROUTES_DATA}};

    // --- Helpers
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => [...el.querySelectorAll(s)];
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    const toMi = km => km * 0.621371;
    const toFt = m  => m  * 3.28084;

    function timeFromMinutes(mins) {
      if (!mins || mins <= 0) return "—";
      const h = Math.floor(mins / 60);
      const m = Math.round(mins % 60);
      return h ? `${h}h ${m}m` : `${m}m`;
    }

    function fmtDistance(km, useImperial) {
      if (!km || km <= 0) return "—";
      return useImperial ? `${toMi(km).toFixed(1)} mi` : `${km.toFixed(1)} km`;
    }
    function fmtElev(m, useImperial) {
      if (!m || m <= 0) return "—";
      return useImperial ? `${Math.round(toFt(m))} ft` : `${Math.round(m)} m`;
    }

    function imgFor(r) {
      const thumb = r.mapImage || r.image;
      const full  = r.mapImageLarge || r.image;
      return { thumb, full };
    }

    // --- Render
    const state = {
      useImperial: false,
      type: 'all'
    };

    const grid = qs('#grid');

    function cardTemplate(r) {
      const { thumb, full } = imgFor(r);
      const hasImg = !!thumb;
      const type = (r.type || 'road').toLowerCase();
      const pillClass = type.includes('gravel') ? 'gravel' : 'road';

      const dist = Number(r.distance || 0);
      const elev = Number(r.elevation || 0);

      return `
        <article class="card" data-type="${type}">
          <div class="imgwrap">
            ${hasImg ? `
              <img loading="lazy" decoding="async"
                   src="${thumb}"
                   srcset="${thumb} 1x, ${full || thumb} 2x"
                   alt="Map preview of ${escapeHtml(r.title || 'route')}">
            ` : `
              <div class="fallback">Map preview unavailable</div>
            `}
          </div>

          <div class="body">
            <div class="title-row">
              <h2 class="route-title">${escapeHtml(r.title || 'Untitled Route')}</h2>
              <span class="pill ${pillClass}">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
            </div>

            ${r.description ? `<p class="desc">${escapeHtml(r.description)}</p>` : ''}

            <div class="stats">
              <div class="stat">Distance: <b data-dist="${dist}"></b></div>
              <div class="stat">Elevation: <b data-elev="${elev}"></b></div>
              <div class="stat">Est. Time: <b>${timeFromMinutes(r.estimatedTime)}</b></div>
            </div>
          </div>

          <div class="actions">
            <a class="btn" href="${full || thumb || '#'}" target="_blank" rel="noopener noreferrer">Preview</a>
            <a class="btn primary" href="${r.rwgpsUrl}" target="_blank" rel="noopener noreferrer">View on RWGPS</a>
          </div>
        </article>
      `;
    }

    function render() {
      // Filter then render
      const filtered = ROUTES.filter(r => state.type === 'all' ? true : (String(r.type||'').toLowerCase().includes(state.type)));
      grid.innerHTML = filtered.map(cardTemplate).join('');

      // Fill numbers according to unit
      updateUnits();

      // Count
      qs('#routeCount').textContent = String(filtered.length);
    }

    function updateUnits() {
      const useImp = state.useImperial;
      qsa('[data-dist]').forEach(el => {
        const km = Number(el.getAttribute('data-dist') || 0);
        el.textContent = fmtDistance(km, useImp);
      });
      qsa('[data-elev]').forEach(el => {
        const m = Number(el.getAttribute('data-elev') || 0);
        el.textContent = fmtElev(m, useImp);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // --- Events
    qs('#unitToggle').addEventListener('change', (e) => {
      state.useImperial = e.currentTarget.checked;
      updateUnits();
    });

    qs('#typeFilter').addEventListener('change', (e) => {
      state.type = e.target.value;
      render();
    });

    // Initial render
    render();
  </script>
</body>
</html>
