<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drinks Mix Calculator - Loudoun Velo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans transition-colors duration-300">

    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
            <div class="text-center md:text-left">
                <a href="../">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">üö¥üèº Loudoun Velo</h1>
                    <p class="mt-1 text-md text-gray-500 dark:text-gray-400">Drinks Mix Calculator</p>
                </a>
            </div>
            <div class="flex flex-row items-center gap-4">
                <button id="theme-toggle"
                    class="p-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 transition-colors">
                </button>
            </div>
        </header>

        <div class="max-w-2xl mx-auto">
            <!-- Settings Panel -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Mix Requirements</h2>
                <!-- Controls -->
                <div class="space-y-6">
                    <div>
                        <label for="target-carbs"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Target Carbs (g)</label>
                        <input type="number" id="target-carbs" value="90"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm p-2 bg-white">
                    </div>

                    <div>
                        <label for="target-ratio"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Target Ratio
                            (Glucose:Fructose)</label>
                        <select id="target-ratio"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm p-2 bg-white">
                            <option value="0.9">1:0.9 (Very High Fructose)</option>
                            <option value="0.8">1:0.8 (High Fructose - Beta Fuel)</option>
                            <option value="0.7">1:0.7 (Moderate High)</option>
                            <option value="0.6">1:0.6 (Standard)</option>
                            <option value="0.5">2:1 (Traditional)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>

                    <div id="custom-ratio-container" class="hidden">
                        <label for="custom-ratio-input"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Custom Ratio Value (e.g.
                            0.8)</label>
                        <input type="number" id="custom-ratio-input" step="0.1"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm p-2 bg-white">
                    </div>

                    <div class="flex items-center gap-2 pt-2 pb-2">
                        <input type="checkbox" id="use-gatorade" class="h-5 w-5 text-blue-600 rounded">
                        <label for="use-gatorade" class="text-base font-medium text-gray-800 dark:text-gray-200">Include
                            Gatorade?</label>
                    </div>

                    <div>
                        <p class="text-sm text-gray-500 italic mt-2">Sodium Citrate is automatically added to reach
                            target sodium levels (720mg/100g carbs).</p>
                    </div>

                    <div>
                        <label for="volume-ml" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Bottle
                            Volume (ml)</label>
                        <input type="number" id="volume-ml" value="750"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm p-2 bg-white">
                    </div>
                </div>

                <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
                    <h4 class="text-xl font-bold text-blue-800 dark:text-blue-300 mb-2">Recipe</h4>
                    <div id="recipe-output"
                        class="p-4 border border-blue-200 bg-blue-50 dark:bg-blue-900/20 dark:border-blue-800 rounded-md mb-8">
                        <ul id="recipe-list" class="space-y-1"></ul>
                    </div>

                    <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Results</h3>
                    <div class="p-4 bg-gray-100 dark:bg-gray-900 rounded-md space-y-2">
                        <div class="flex justify-between">
                            <span>Total Carbs:</span>
                            <span id="result-carbs" class="font-bold">0g</span>
                        </div>
                        <div class="flex justify-between pl-4 text-sm text-gray-600 dark:text-gray-400">
                            <span>Glucose:</span> <span id="result-glucose">0g</span>
                        </div>
                        <div class="flex justify-between pl-4 text-sm text-gray-600 dark:text-gray-400">
                            <span>Fructose:</span> <span id="result-fructose">0g</span>
                        </div>

                        <div class="flex justify-between border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
                            <span>Sodium:</span>
                            <span id="result-sodium" class="font-bold">0mg</span>
                        </div>
                        <div class="flex justify-between pl-4 text-sm text-gray-600 dark:text-gray-400">
                            <span>(Target: 7.2mg per g carb)</span>
                        </div>

                        <div class="flex justify-between border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
                            <span>Potassium:</span>
                            <span id="result-potassium" class="font-bold">0mg</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Calcium:</span>
                            <span id="result-calcium" class="font-bold">0mg</span>
                        </div>

                        <div class="flex justify-between border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
                            <span>Cost:</span>
                            <span id="result-cost" class="font-bold text-green-600 dark:text-green-400">$0.00</span>
                        </div>

                        <div class="flex justify-between border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
                            <span>Ratio (G:F):</span>
                            <span id="result-ratio" class="font-bold">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Concentration:</span>
                            <span id="result-concentration" class="font-bold">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center py-8 mt-4">
            <p class="text-sm text-gray-600 dark:text-gray-400">
                Made with ‚ù§Ô∏è for the NoVA cycling community by <a href="https://www.strava.com/athletes/23573109"
                    target="_blank" rel="noopener noreferrer"
                    class="text-blue-600 dark:text-blue-400 hover:underline">Darren O'Connor</a>
            </p>
        </footer>
    </div>


    <!-- Add Ingredient Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
            <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">Add Ingredient</h3>
            <div class="space-y-3">
                <input type="text" id="new-name" placeholder="Name (e.g. Maltodextrin)"
                    class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="new-carbs" placeholder="Carbs per 100g"
                        class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                    <input type="number" id="new-sodium" placeholder="Sodium (mg) per 100g"
                        class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">G:F Ratio (approx)</label>
                    <select id="new-ratio-type" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                        <option value="1:0">100% Glucose (Maltodextrin)</option>
                        <option value="0:1">100% Fructose</option>
                        <option value="1:1">50/50 (Sucrose/Sugar)</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-modal"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800 dark:text-gray-400">Cancel</button>
                <button id="save-modal" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Logic
        // Injected by build.py. NOTE: Placeholder must match build.py exactly (no spaces)
        let dbIngredients = {{INGREDIENTS_DATA}};

        // Fallback for dev if injection isn't present or failed
        if (!Array.isArray(dbIngredients) || dbIngredients.length === 0) {
            console.warn("Using fallback ingredients data");
            // IDs should match the new stripped list
            dbIngredients = [
                { id: 1, name: 'Maltodextrin', carbs: 94, sodium: 71.4, glucose: 100, fructose: 0, potassium: 0, calcium: 25.4, cost: 0.00931, active: true, amount: 0 },
                { id: 2, name: 'Gatorade Powder', carbs: 100, sodium: 652.2, glucose: 60, fructose: 40, potassium: 217.4, calcium: 0, cost: 0.00737, active: false, amount: 0 },
                { id: 3, name: 'Table Sugar', carbs: 100, sodium: 0, glucose: 50, fructose: 50, potassium: 0, calcium: 0, cost: 0.00181, active: true, amount: 0 },
                { id: 4, name: 'Sodium Citrate', carbs: 0, sodium: 23600, glucose: 0, fructose: 0, potassium: 0, calcium: 0, cost: 0.02203, active: true, amount: 0 }
            ];
        }

        // Deep copy to created mutable state
        let ingredients = JSON.parse(JSON.stringify(dbIngredients));

        // DOM Elements
        const targetCarbsInput = document.getElementById('target-carbs');
        const targetRatioSelect = document.getElementById('target-ratio');
        const customRatioInput = document.getElementById('custom-ratio-input');
        const customRatioContainer = document.getElementById('custom-ratio-container');

        const gatoradeToggle = document.getElementById('use-gatorade');
        // const sodiumInput = document.getElementById('sodium-input'); // Removed/Auto-solved

        const resultCarbs = document.getElementById('result-carbs');
        const resultSodium = document.getElementById('result-sodium');
        const resultRatio = document.getElementById('result-ratio');
        const resultConc = document.getElementById('result-concentration');

        // New Mineral Outputs
        const resultPotassium = document.getElementById('result-potassium');
        const resultCalcium = document.getElementById('result-calcium');
        const resultGlucose = document.getElementById('result-glucose');
        const resultFructose = document.getElementById('result-fructose');

        const volumeInput = document.getElementById('volume-ml');

        const recipeOutput = document.getElementById('recipe-output');
        const recipeList = document.getElementById('recipe-list');

        // Theme
        let isDarkMode = localStorage.getItem("isDarkMode") === "true";
        const themeBtn = document.getElementById('theme-toggle');

        function updateTheme() {
            document.documentElement.classList.toggle('dark', isDarkMode);
            const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-6.364-.386 1.591-1.591M3 12h2.25m.386-6.364 1.591 1.591" /></svg>`;
            const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" /></svg>`;
            themeBtn.innerHTML = isDarkMode ? sunIcon : moonIcon;
        }
        themeBtn.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            localStorage.setItem("isDarkMode", isDarkMode);
            updateTheme();
        });


        // --- Persistence & Defaults ---
        function loadState() {
            const savedCarbs = localStorage.getItem('mix_targetCarbs');
            const savedRatio = localStorage.getItem('mix_targetRatio');
            const savedCustomRatio = localStorage.getItem('mix_customRatio');
            const savedVolume = localStorage.getItem('mix_volume');
            const useGatorade = localStorage.getItem('mix_useGatorade') === 'true';

            // Apply Defaults
            targetCarbsInput.value = savedCarbs ? savedCarbs : "90";
            targetRatioSelect.value = savedRatio ? savedRatio : "0.8";

            if (targetRatioSelect.value === 'custom') {
                customRatioContainer.classList.remove('hidden');
                customRatioInput.value = savedCustomRatio || "1.0";
            }

            volumeInput.value = savedVolume ? savedVolume : "750";
            gatoradeToggle.checked = useGatorade;
        }

        function saveState() {
            localStorage.setItem('mix_targetCarbs', targetCarbsInput.value);
            localStorage.setItem('mix_targetRatio', targetRatioSelect.value);
            localStorage.setItem('mix_customRatio', customRatioInput.value);
            localStorage.setItem('mix_volume', volumeInput.value);
            localStorage.setItem('mix_useGatorade', gatoradeToggle.checked);
        }

        // --- Logic ---

        function getIngredientByName(name) {
            return ingredients.find(i => i.name.toLowerCase().includes(name.toLowerCase()));
        }

        function solve() {
            const targetCarbs = parseFloat(targetCarbsInput.value) || 0;
            let ratioVal = 1.0;

            if (targetRatioSelect.value === 'custom') {
                customRatioContainer.classList.remove('hidden');
                ratioVal = parseFloat(customRatioInput.value) || 1.0;
            } else {
                customRatioContainer.classList.add('hidden');
                ratioVal = parseFloat(targetRatioSelect.value);
            }

            // Ratio is G:F. User selects "N" for "1:N".
            // So G=1, F=N. Total Parts = 1+N.
            // F_targ = C * (N / (1+N)).

            const F_targ = targetCarbs * (ratioVal / (ratioVal + 1));
            const G_targ = targetCarbs - F_targ;

            // Ingredients
            const malto = getIngredientByName('Maltodextrin') || ingredients[0];
            const sugar = getIngredientByName('Sugar') || ingredients[2];
            const gatorade = getIngredientByName('Gatorade') || ingredients[1];
            const sodCit = getIngredientByName('Sodium') || ingredients[3]; // 'Sodium Citrate' in name matches 'Sodium'

            // Resets
            malto.amount = 0;
            sugar.amount = 0;
            gatorade.amount = 0;
            sodCit.amount = 0;

            // 1. Gatorade Logic
            let F_gat = 0;
            let G_gat = 0;

            if (gatoradeToggle.checked && gatorade) {
                // "gatorade fructose amount would equal total fructose divided by 6"
                F_gat = F_targ / 6.0;

                // Gatorade G:F = 60:40 (1.5)
                G_gat = F_gat * (gatorade.glucose / gatorade.fructose);

                // Set amount
                const gat_total_carbs = F_gat + G_gat;
                gatorade.amount = gat_total_carbs / (gatorade.carbs / 100);
            }

            // 2. Sugar Logic
            let F_sug = 0;
            let G_sug = 0;
            if (sugar) {
                // "sugar would equal total fructose - amount of fructose from gatorade"
                // "then double the value as sugar is 50:50" (mass of carbs)
                F_sug = Math.max(0, F_targ - F_gat);
                G_sug = F_sug; // Sugar is 50:50

                const sugar_total_carbs = F_sug + G_sug;
                sugar.amount = sugar_total_carbs / (sugar.carbs / 100);
            }

            // 3. Maltodextrin Logic
            let G_malto = 0;
            if (malto) {
                // "lamtodrextin would equal total glucose - amount of glucose from gatorade mix - amount of glucose from sugar"
                const G_needed = G_targ - G_gat - G_sug;
                G_malto = Math.max(0, G_needed);

                malto.amount = G_malto / (malto.carbs / 100);
            }

            // 4. Sodium Solver
            // Rule: "7.2mg of sodium per 1g of carbs"
            // Target Sodium (mg) = Carbs * 7.2
            const targetNa = targetCarbs * 7.2;

            // Current Sodium from ingredients (mg)
            // (Amount (g) * Sodium (mg/100g) / 100) -> Correct: Sodium col is mg/100g ? Or mg/kg?
            // User inputs imply mg/100g format earlier (e.g. 24000). But updated data:
            // "in 23g of gatorade... 150mg Na" -> 652 mg/100g.
            // Malto: 71.4 mg/100g.
            // Sodium Citrate 23600 mg/100g.

            let currentNa = 0;
            [malto, sugar, gatorade].forEach(i => {
                if (i && i.amount > 0) {
                    currentNa += i.amount * (i.sodium / 100.0);
                }
            });

            const neededNa = Math.max(0, targetNa - currentNa);

            if (sodCit) {
                // Amount (g) = Needed (mg) / (Sodium Content (mg/g))
                // SodCit Content = 23600 mg / 100g = 236 mg/g.
                const sodCitDensity = sodCit.sodium / 100.0;
                if (sodCitDensity > 0) {
                    sodCit.amount = neededNa / sodCitDensity;
                }
            }

            renderOutput();
        }

        function renderOutput() {
            let totalCarbs = 0;
            let totalNa = 0;
            let totalK = 0;
            let totalCa = 0;
            let totalG = 0;
            let totalF = 0;

            recipeList.innerHTML = '';

            // Strict order: Malto, Gatorade, Sugar, SodCit
            // Filter inactive/missing
            const displayOrder = ['Maltodextrin', 'Gatorade', 'Sugar', 'Sodium'];

            // Helper to sort by vague name match
            const sortedIngs = ingredients.filter(i => i.amount > 0).sort((a, b) => {
                const aIdx = displayOrder.findIndex(k => a.name.includes(k));
                const bIdx = displayOrder.findIndex(k => b.name.includes(k));
                return (aIdx === -1 ? 99 : aIdx) - (bIdx === -1 ? 99 : bIdx);
            });

            sortedIngs.forEach(i => {
                const carbs = i.amount * (i.carbs / 100);
                const na = i.amount * (i.sodium / 100);
                const k = i.amount * (i.potassium / 100);
                const ca = i.amount * (i.calcium / 100);

                const sum = i.glucose + i.fructose || 100;
                const g = carbs * (i.glucose / sum);
                const f = carbs * (i.fructose / sum);

                totalCarbs += carbs;
                totalNa += na;     // Already mg
                totalK += k;
                totalCa += ca;

                totalG += g;
                totalF += f;

                // Links
                let link = null;
                const n = i.name.toLowerCase();
                if (n.includes('maltodextrin')) link = "https://www.amazon.com/NOW-Nutrition-Maltodextrin-Absorption-Production/dp/B0013OUNRM";
                else if (n.includes('sodium citrate')) link = "https://www.amazon.com/Anthonys-Premium-Sodium-Citrate-Emulsifier/dp/B07T927Z6R?th=1";
                else if (n.includes('gatorade')) link = "https://www.amazon.com/Gatorade-Thirst-Quencher-Powder-Glacier/dp/B07CT8182P?th=1";

                const nameHtml = link
                    ? `<a href="${link}" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-600 dark:text-blue-400 hover:underline">${i.name}</a>`
                    : `<span class="font-medium text-gray-800 dark:text-gray-200">${i.name}</span>`;

                const li = document.createElement('li');
                li.className = "flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700 last:border-0";
                li.innerHTML = `${nameHtml} <span class="font-bold text-blue-600 dark:text-blue-400">${i.amount.toFixed(1)} g</span>`;
                recipeList.appendChild(li);
            });

            if (sortedIngs.length > 0) {
                recipeOutput.classList.remove('hidden');
            } else {
                recipeOutput.classList.add('hidden');
            }

            resultCarbs.textContent = `${totalCarbs.toFixed(1)}g`;
            resultSodium.textContent = `${totalNa.toFixed(0)}mg`;

            // New Outputs
            if (resultPotassium) resultPotassium.textContent = `${totalK.toFixed(0)}mg`;
            if (resultCalcium) resultCalcium.textContent = `${totalCa.toFixed(0)}mg`;
            if (resultGlucose) resultGlucose.textContent = `${totalG.toFixed(1)}g`;
            if (resultFructose) resultFructose.textContent = `${totalF.toFixed(1)}g`;

            // Cost Calculation
            let totalCost = 0;
            sortedIngs.forEach(i => {
                const costPerGram = i.cost || 0;
                totalCost += i.amount * costPerGram;
            });
            const resultCost = document.getElementById('result-cost');
            if (resultCost) resultCost.textContent = `$${totalCost.toFixed(2)}`;

            const ratio = totalF > 0 ? (totalG / totalF).toFixed(2) : (totalG > 0 ? "1:0" : "-");
            resultRatio.textContent = totalF > 0 ? `${ratio}:1` : ratio;

            const vol = parseFloat(volumeInput.value) || 750;
            const conc = vol > 0 ? (totalCarbs / vol) * 100 : 0;
            resultConc.textContent = `${conc.toFixed(1)}%`;
        }

        // Listeners
        function onSettingChange() {
            saveState();
            solve();
        }

        targetCarbsInput.addEventListener('input', onSettingChange);
        targetRatioSelect.addEventListener('change', onSettingChange);
        customRatioInput.addEventListener('input', onSettingChange);
        volumeInput.addEventListener('input', onSettingChange);
        gatoradeToggle.addEventListener('change', onSettingChange);

        // Init
        updateTheme();
        loadState();
        solve();

    </script>
</body>

</html>